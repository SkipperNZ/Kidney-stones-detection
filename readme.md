# Kidney stones detection

Так как времени очень ограниченное колличество то я не стал писать новый треин/тест луп а решил больше сконцентрироваться на данных. В качестве модели и для детекции и для классификации взял `yoloV10s` от `ultralitics` и заодно немного освоил их фереймворк обучения))). \
Детектор из коробки вместе с детекцией боксов предсказывает и метку класса,но если нужна только классификации можно подставить `-cls` в название модели. В целом для начала и её тоже хватит. \
### Что делал
- Первое что сделал это разбил рандомно данные на `train`/`val`, переформатировал данные под yolo формат: пересчитал bbox в относительные значения, переместил картинки в `datasets/images` а метки и боксы в `datasets/labels`, подготовил для обучения `dataset.yaml` и файлик для запуска обучения `train_ultralitic_yolo.py`
- После обучения первой пробной модельки стало понятно что есть большой даталик в валидацию, но оно и понятно у нас прочти все картинки это последовательности кадров и многие из них почти одинаковые: ![Пример дубликатов](for_report\dublicates.png)
- Что бы это поправить я с помощью `imagededup` нашел все похожие по хешу картинки и перенес их из валидации обратно в трейн.
- После обучил 2ую уже финальную модельку. Все равно видимо из за того что данных относительно немного (последовательности по сути являются одной "натурально" аугментированной картинкой + проблемы которые опишу в следующих пунктах)  моделька неплохо переобучается. \
Графики лоссов и метрики (их же в логах тензорборда можно посмотреть по подробней):
![Results](runs\train\exp\results.png)

- В целом на валидации модель дает неплохие предсказания однако в данных еще много проблем и вероятно тут есть большая доля оверфита: 

| Metric     | Images | Instances | Box(P) | R     | mAP50 | mAP50-95 |
|------------|--------|-----------|--------|-------|-------|----------|
| **All**        | 403    | 437       | 0.973  | 0.970 | 0.986 | 0.872    |
| **Oxalate**    | 92     | 92        | 0.978  | 0.977 | 0.992 | 0.912    |
| **Phosphate**  | 118    | 130       | 0.992  | 0.969 | 0.983 | 0.809    |
| **Urate**      | 87     | 95        | 0.929  | 0.979 | 0.976 | 0.893    |
| **Stone**      | 106    | 120       | 0.991  | 0.953 | 0.990 | 0.875    |

- Все графики, результаты, метрики, примеры для модели и веса `ultralitics` генерируют и любезно складывают в папку `runs\train\exp`

### Примеры детекции и классификации
![Example1](for_report\2_stones.png) 
![Example2](for_report\good_predict.png) 

### То что нужно добавить
Заметил некоторые особенности в данных но не успел с этим что то сделать:
- Многие картинки сами по себе практически не информативны из за сильного блюра и камня на весь кадр, по сути такие картикни мало информативны и классификация в них происходит только по цвету, в обучении я бы их не использовал. Примеры: \
![Blur1](for_report\stone_hard.png) ![Blur2](for_report\val_predict_hard2.png) 

- Часть картинок имеет черную виньетку, а часть нет. можно добавить её как аугментацию так как это тоже может вносить искажения. + часть картинок была слишком сильно пережата, её я бы тоже из обучения убрал либо кропнул паддинг:
![paddings](for_report\25.09.23_perc_ultramini.mp4_424.png) 
- Данная модель выучивалась по стандартному пайплайно с полным набором аугментаций. Более подробно о них написано тут: https://docs.ultralytics.com/reference/data/augment/ \
Изходя из доменных знаний вероянтно часть из них надо отключить так как они могут сильно мешаться.
- Так же я бы все таки написал полноценный пайплайн на лайтнинге и попробовал другие интересные модели, например какой нибудь sota detr или какой нибудь swin как классификатор если есть еще много данных итд. Но тут надо быть аккуратней что бы требования к real-time сохранялиь. 
- Поресерчить статьи (https://scholar.google.com/scholar?hl=ru&as_sdt=0%2C5&q=Kidney+stones+detection&btnG=) Вероятно уже кто то решил подобную задачку.



### Как пользоваться
- Для обучения модели надо запустить `train_ultralitic_yolo.py` с желаемыми аргументами.
- Инференс можно попробовать в ноутбуке `inference.ipynb`. Функция `predict_and_plot_picture` принимает путь до картинки и загруженную модель, делает предикт и рисует картинку с боксами и лейблами.
- в модуле `Predict internet examples` ячейка сама парсит папку и достаточно выбрать только нужный индекс. Сделал небольшой инференс на картинках которые нашел в статьях в интернете, видно что модель в основном предсказывает все как `Stone` видна и переобученность и домейн геп, однако моделька неплохо предсказывает боксы.
- `Draw pics from dataset (predict and GT)` в этом модуле строим картинку и предсказания вместе с `Gt` из датасета в `predict_from_dataset` надо так же передать модельку и путь до картинки в датасете, gt значения она подтянет сама.

